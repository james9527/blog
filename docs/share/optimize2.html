<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>移动端性能优化（二） | james9527的前端日志</title>
    <meta name="description" content="欢迎访问我的前端日志~">
    <link rel="icon" href="https://github.githubassets.com/favicon.ico">
  <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/assets/css/0.styles.50972fb1.css" as="style"><link rel="preload" href="/assets/js/app.084c26c5.js" as="script"><link rel="preload" href="/assets/js/2.9f793532.js" as="script"><link rel="preload" href="/assets/js/3.bfde9e20.js" as="script"><link rel="prefetch" href="/assets/js/10.733d44b2.js"><link rel="prefetch" href="/assets/js/11.40a98b51.js"><link rel="prefetch" href="/assets/js/12.e0360759.js"><link rel="prefetch" href="/assets/js/13.86bc1af2.js"><link rel="prefetch" href="/assets/js/14.328ad459.js"><link rel="prefetch" href="/assets/js/15.2bb30d98.js"><link rel="prefetch" href="/assets/js/16.aa0d9571.js"><link rel="prefetch" href="/assets/js/17.6d9df7f0.js"><link rel="prefetch" href="/assets/js/18.eff160d9.js"><link rel="prefetch" href="/assets/js/19.7bb6e861.js"><link rel="prefetch" href="/assets/js/20.32f862c8.js"><link rel="prefetch" href="/assets/js/21.0dd1fde4.js"><link rel="prefetch" href="/assets/js/22.969223f3.js"><link rel="prefetch" href="/assets/js/23.daa7c886.js"><link rel="prefetch" href="/assets/js/24.f718d4fd.js"><link rel="prefetch" href="/assets/js/25.57e87518.js"><link rel="prefetch" href="/assets/js/26.4528cfd6.js"><link rel="prefetch" href="/assets/js/27.f5f0c3a2.js"><link rel="prefetch" href="/assets/js/28.1d479ba1.js"><link rel="prefetch" href="/assets/js/29.84b31681.js"><link rel="prefetch" href="/assets/js/30.9f012d81.js"><link rel="prefetch" href="/assets/js/4.1f77bde4.js"><link rel="prefetch" href="/assets/js/5.9e202651.js"><link rel="prefetch" href="/assets/js/6.fe752fd6.js"><link rel="prefetch" href="/assets/js/7.36d98635.js"><link rel="prefetch" href="/assets/js/8.9ef81779.js"><link rel="prefetch" href="/assets/js/9.1a9c7e02.js">
    <link rel="stylesheet" href="/assets/css/0.styles.50972fb1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">james9527的前端日志</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随手记系列" class="dropdown-title"><span class="title">随手记系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/share/eslint.html" class="nav-link">eslint规则</a></li><li class="dropdown-item"><!----> <a href="/share/opt.html" class="nav-link">性能优化</a></li><li class="dropdown-item"><!----> <a href="/share/webpack.html" class="nav-link">深入webpack</a></li><li class="dropdown-item"><!----> <a href="/share/webpack-note.html" class="nav-link">webpack随手记</a></li><li class="dropdown-item"><!----> <a href="/share/wechat.html" class="nav-link">公众号开发总结</a></li><li class="dropdown-item"><!----> <a href="/share/scaffold.html" class="nav-link">深入浅出前端脚手架</a></li><li class="dropdown-item"><!----> <a href="/share/javascript-basic.html" class="nav-link">前端基础JS系列</a></li><li class="dropdown-item"><!----> <a href="/share/optimize.html" class="nav-link">移动端性能优化(一)</a></li><li class="dropdown-item"><!----> <a href="/share/optimize2.html" class="nav-link router-link-exact-active router-link-active">移动端性能优化(二)</a></li><li class="dropdown-item"><!----> <a href="/share/md.html" class="nav-link">markdown语法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工作相关" class="dropdown-title"><span class="title">工作相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/skulpt/1.html" class="nav-link">深入skulpt</a></li><li class="dropdown-item"><!----> <a href="/scratch/links.html" class="nav-link">深入scratch</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机英语" class="dropdown-title"><span class="title">计算机英语</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/webpack.html" class="nav-link">webpack 英文</a></li><li class="dropdown-item"><!----> <a href="/en/npm.html" class="nav-link">npm 英文</a></li><li class="dropdown-item"><!----> <a href="/en/skulpt.html" class="nav-link">skulpt 英文</a></li><li class="dropdown-item"><!----> <a href="/en/scratch.html" class="nav-link">scratch 英文</a></li><li class="dropdown-item"><!----> <a href="/en/ecma.html" class="nav-link">ecma 英文</a></li></ul></div></div><div class="nav-item"><a href="/url/fe.html" class="nav-link">常用网址</a></div><div class="nav-item"><a href="https://github.com/james9527" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随手记系列" class="dropdown-title"><span class="title">随手记系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/share/eslint.html" class="nav-link">eslint规则</a></li><li class="dropdown-item"><!----> <a href="/share/opt.html" class="nav-link">性能优化</a></li><li class="dropdown-item"><!----> <a href="/share/webpack.html" class="nav-link">深入webpack</a></li><li class="dropdown-item"><!----> <a href="/share/webpack-note.html" class="nav-link">webpack随手记</a></li><li class="dropdown-item"><!----> <a href="/share/wechat.html" class="nav-link">公众号开发总结</a></li><li class="dropdown-item"><!----> <a href="/share/scaffold.html" class="nav-link">深入浅出前端脚手架</a></li><li class="dropdown-item"><!----> <a href="/share/javascript-basic.html" class="nav-link">前端基础JS系列</a></li><li class="dropdown-item"><!----> <a href="/share/optimize.html" class="nav-link">移动端性能优化(一)</a></li><li class="dropdown-item"><!----> <a href="/share/optimize2.html" class="nav-link router-link-exact-active router-link-active">移动端性能优化(二)</a></li><li class="dropdown-item"><!----> <a href="/share/md.html" class="nav-link">markdown语法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工作相关" class="dropdown-title"><span class="title">工作相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/skulpt/1.html" class="nav-link">深入skulpt</a></li><li class="dropdown-item"><!----> <a href="/scratch/links.html" class="nav-link">深入scratch</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机英语" class="dropdown-title"><span class="title">计算机英语</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/webpack.html" class="nav-link">webpack 英文</a></li><li class="dropdown-item"><!----> <a href="/en/npm.html" class="nav-link">npm 英文</a></li><li class="dropdown-item"><!----> <a href="/en/skulpt.html" class="nav-link">skulpt 英文</a></li><li class="dropdown-item"><!----> <a href="/en/scratch.html" class="nav-link">scratch 英文</a></li><li class="dropdown-item"><!----> <a href="/en/ecma.html" class="nav-link">ecma 英文</a></li></ul></div></div><div class="nav-item"><a href="/url/fe.html" class="nav-link">常用网址</a></div><div class="nav-item"><a href="https://github.com/james9527" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>移动端性能优化（二）</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/share/optimize2.html#如何减小请求大小？" class="sidebar-link">如何减小请求大小？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/share/optimize2.html#_1、js-css-html压缩" class="sidebar-link">1、JS/CSS/HTML压缩</a></li><li class="sidebar-sub-header"><a href="/share/optimize2.html#_2、gzip压缩" class="sidebar-link">2、gzip压缩</a></li><li class="sidebar-sub-header"><a href="/share/optimize2.html#_3、js-css按需加载" class="sidebar-link">3、JS/CSS按需加载</a></li><li class="sidebar-sub-header"><a href="/share/optimize2.html#_4、图片压缩，jpg优化" class="sidebar-link">4、图片压缩，jpg优化</a></li><li class="sidebar-sub-header"><a href="/share/optimize2.html#_5、webp优化-srcset优化" class="sidebar-link">5、webp优化 &amp; srcset优化</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="移动端性能优化总结（二）"><a href="#移动端性能优化总结（二）" class="header-anchor">#</a> 移动端性能优化总结（二）</h1> <h2 id="如何减小请求大小？"><a href="#如何减小请求大小？" class="header-anchor">#</a> 如何减小请求大小？</h2> <h3 id="_1、js-css-html压缩"><a href="#_1、js-css-html压缩" class="header-anchor">#</a> 1、JS/CSS/HTML压缩</h3> <p>这也是常规手段，就不介绍太多，主要的方式有：<br>
1、通过构建工具实现，比如webpack/gulp/fis/grunt等。<br>
2、后台预编译。<br>
3、利用第三方online平台，手动上传压缩。<br>
无论是第二种还是第三种方式，都有其局限性，第一种方法是目前的主流方式，凭借良好的插件生态，可以实现丰富的构建任务。<br>
在我们的项目中，我们使用webpack作为构建系统的基础。<br></p> <p>简单介绍一下JS/CSS/HTML压缩方式和一些注意事项。</p> <p><b>JS压缩</b></p> <p>JS压缩：使用webpack的UglifyJsPlugin插件，同时做一些代码检测。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    mangle<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        except<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'$super'</span><span class="token punctuation">,</span> <span class="token string">'$'</span><span class="token punctuation">,</span> <span class="token string">'exports'</span><span class="token punctuation">,</span> <span class="token string">'require'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><b>CSS压缩</b></p> <p>CSS压缩：使用cssnano压缩，同时使用postcss做一些自动化操作，比如自动加前缀、属性fallback支持、语法检测等。</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">var</span> postcss <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token function">cssnano</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            autoprefixer<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            reduceIdents<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            zindex<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            discardUnused<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            mergeIdents<span class="token punctuation">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">autoprefixer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> browers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'last 2 versions'</span><span class="token punctuation">,</span> <span class="token string">'ie &gt;= 9'</span><span class="token punctuation">,</span> <span class="token string">'&gt; 5% in CN'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        will_change<span class="token punctuation">,</span>
        color_rgba_fallback<span class="token punctuation">,</span>
        opacity<span class="token punctuation">,</span>
        pseudoelements<span class="token punctuation">,</span>
        sorting
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p><b>HTML压缩</b></p> <p>HTML压缩：使用htmlmin压缩HTML，同时对不规范的HTML写法纠正。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 构建视图文件-build版本</span>
gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'build:views'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'clean:views'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">streamqueue</span><span class="token punctuation">(</span><span class="token punctuation">{</span> objectMode<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>commonSrc<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token punctuation">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>layoutsSrc<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token punctuation">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>pagesSrc<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token punctuation">:</span> <span class="token string">'src/pages'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>componentsSrc<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token punctuation">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">plumber</span><span class="token punctuation">(</span>handleErrors<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">{</span> showChange<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">preprocess</span><span class="token punctuation">(</span><span class="token punctuation">{</span> context<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token constant">PROJECT</span><span class="token punctuation">:</span> project <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">gulpif</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.html'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            removeComments<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            collapseWhitespace<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            minifyJS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            minifyCSS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            ignoreCustomFragments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token regex">/&lt;%[\s\S]*?%&gt;/</span><span class="token punctuation">,</span> 
                                    <span class="token regex">/&lt;\?[\s\S]*?\?&gt;/</span><span class="token punctuation">,</span> 
                                    <span class="token regex">/&lt;meta[\s\S]*?name=&quot;viewport&quot;[\s\S]*?&gt;/</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>dest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>某个第三方平台要求</p><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no">必须写成小数点格式，而htmlmin默认会将小数格式化为整数，所以额外添加了排除项：/&lt;meta[\s\S]<em>?name=&quot;viewport&quot;[\s\S]</em>?&gt;/。到现在都没懂这个第三方平台咋想的！<p></p> <p><b>条件编译</b></p> <p>由于好奇心日报项目较多，我们费了很大的心思抽离出前端项目，实现了前后分离。但有些场景下，我们为了将相关代码维护在一个文件中，同时又针对不同项目执行不同的逻辑，这时候，强烈推荐使用 gulp-preprocess插件 来实现条件编译。</p> <p><img src="/assets/img/7.a5f9e60d.png" style="width:60%;"><br></p> <h3 id="_2、gzip压缩"><a href="#_2、gzip压缩" class="header-anchor">#</a> 2、gzip压缩</h3> <p>gzip压缩也是比较常规的优化手段。前端并不需要做什么实际的工作，后台配置下服务器就行，效果非常明显。如果你发现你的网站还没有配置gzip，那么赶紧行动起来吧。</p> <p><b>gzip压缩原理</b></p> <p>如果浏览器支持gzip压缩，在发送请求的时候，请求头中会带有Accept-Encoding:gzip。然后服务器会将原始的response进行gzip压缩，并将gzip压缩后的response传输到浏览器，紧接着浏览器进行gzip解压缩，并最终反馈到网页上。</p> <p><img src="/assets/img/8.1dad4b00.png" style="width:80%;"><br></p> <p><b>gzip压缩效果</b></p> <p>那么gzip压缩的效果有多明显呢？保守估计，在已经完成JS/CSS/HTML压缩的基础上，还能降低60-80%左右的大小。</p> <p><img src="/assets/img/9.a7128e8a.png" style="width:80%;"><br></p> <p>但需要注意，gzip压缩会消耗服务器的性能，不能过度压缩。<br>
所以推荐只对JS/CSS/HTML等资源做gzip压缩。图片的话，托管到第三方的图片建议开启gzip压缩，托管到自己应用服务器的图片不建议开启gzip压缩。</p> <h3 id="_3、js-css按需加载"><a href="#_3、js-css按需加载" class="header-anchor">#</a> 3、JS/CSS按需加载</h3> <p>和前面提到的按需打包不同。<br>
JS/CSS按需打包是预编译发生的事情，保证只打包当前页面相关的逻辑。<br>
JS/CSS按需加载是运行时发生的事情，保证只加载当前页面第一时间使用到的逻辑。<br></p> <p>那么怎么实现按需加载呢？好奇心日报使用webpack提供的require及require.ensure方法来实现按需加载，值得一提的是，除了指定的按需加载文件列表，webpack还会自动解析回调函数的依赖及指定列表的深层次依赖，并最终打包成一个文件。</p> <p><img src="/assets/img/10.16366a3f.png" style="width:80%;"><br></p> <p>上诉代码的实现效果是：只有当点击登录按钮的时候，才会去加载登录相关的JS/CSS资源。资源在加载成功后自动执行。</p> <h3 id="_4、图片压缩，jpg优化"><a href="#_4、图片压缩，jpg优化" class="header-anchor">#</a> 4、图片压缩，jpg优化</h3> <p><b>托管到应用服务器的图片压缩</b></p> <p>可以手动处理，也可以通过gulp子任务来处理。<br>
手动处理的话，推荐一个网站 tinypng ，虽然是有损压缩，但压缩效果极好。<br>
gulp子任务处理的话，推荐使用gulp-imagemin插件，自动化处理，效果也还不错。<br></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 图片压缩</span>
gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'images'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>src<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">plumber</span><span class="token punctuation">(</span>handleErrors<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">newer</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>dest<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">{</span> showChange<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 压缩</span>
        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>dest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><b>托管到第三方平台的图片压缩</b></p> <p>比如七牛云平台，他们会有一套专门的方案来对图片压缩，格式转换，裁剪等。只需要在url后面加上对应的参数即可，虽然偶尔会有一些小bug，但整体来说，托管方案比用自家应用服务器方案更优。</p> <img src="/assets/img/11.1d57204a.png" style="width:80%;"> <p><b>jpg优化</b></p> <p>除了对图片进行压缩之外，对透明图床没有要求的场景，强烈建议将png转换为jpg，效果很明显！<br>
如下图，将png格式化为jpg格式，图片相差差不多8倍！</p> <img src="/assets/img/12.6eae0b94.png" style="width:80%;"> <p>再次强调，可以转换成jpg的图片，强烈建议转换成jpg！</p> <h3 id="_5、webp优化-srcset优化"><a href="#_5、webp优化-srcset优化" class="header-anchor">#</a> 5、webp优化 &amp; srcset优化</h3> <p><b>webp优化</b></p> <p>粗略看一眼，卧槽，兼容性这么差，也就安卓浏览器及chrome浏览器对它的支持还算给力。</p> <img src="/assets/img/13.3bc6f5d0.png" style="width:80%;"> <p>另一方面，webp优化能在jpg的基础上再降低近50%的大小。其优化效果明显。此外，如果浏览器支持webpanimation，还能对gif做压缩！</p> <img src="/assets/img/14.71422c60.png" style="width:80%;"> <img src="/assets/img/15.ef9d872f.png" style="width:80%;"> <p>兼容性差，但效果好！最终好奇心决定尝试一下。<br>
1、判断浏览器对webp及webpanimation的兼容性。<br>
2、如果浏览器支持webp及webpanimation，将其替换成webp格式的图片。<br></p> <p>鉴于浏览器对webp的支持比较局限，我们采用渐进升级的方式来优化：对于不支持webp的浏览器，不做处理；对于支持webp的浏览器，将图片src替换成webp格式。<br>
那么如何判断webp兼容性呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 检测浏览器是否支持webp</span>
<span class="token comment">// 之所以没写成回调，是因为即使isSupportWebp=false也无大碍，但却可以让代码更容易维护</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">webpTest</span><span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            isSupport <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            className<span class="token punctuation">,</span> cls<span class="token punctuation">;</span>

        img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isSupport <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>height <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> img<span class="token punctuation">.</span>width <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            cls <span class="token operator">=</span> isSupport <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">' '</span> <span class="token operator">+</span> name<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">' no-'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            className <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>className
            className <span class="token operator">+=</span> cls<span class="token punctuation">;</span>

            document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>className <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cls <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">' no-'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            className <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>className
            className <span class="token operator">+=</span> cls<span class="token punctuation">;</span>

            document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>className <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        img<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> webpSrc <span class="token operator">=</span> <span class="token string">'data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoB\
                AAEAAwA0JaQAA3AA/vuUAAA='</span><span class="token punctuation">,</span>
        webpanimationSrc <span class="token operator">=</span> <span class="token string">'data:image/webp;base64,UklGRlIAAABXRUJQVlA4WAoAAAA\
                            SAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAA\
                            AAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA'</span><span class="token punctuation">;</span>

    <span class="token function">webpTest</span><span class="token punctuation">(</span>webpSrc<span class="token punctuation">,</span> <span class="token string">'webp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">webpTest</span><span class="token punctuation">(</span>webpanimationSrc<span class="token punctuation">,</span> <span class="token string">'webpanimation'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>借鉴modernizr，实现了检测webp/webpanimation兼容性的函数，从代码中可以看出，检测原理就是模拟下载对应格式的图片，在异步函数中可以得到兼容性结果。</p> <p>接下来就是替换url为webp格式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取webp格式的src</span>
<span class="token keyword">function</span> <span class="token function">_getWebpSrc</span><span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> dpr <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>devicePixelRatio <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        ratio <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        elHtml <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        isSupportWebp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token regex">/(^|\s)webp(\s|$)/i</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>elHtml<span class="token punctuation">.</span>className<span class="token punctuation">)</span><span class="token punctuation">,</span>
        isSupportWebpAnimation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token regex">/(^|\s)webpanimation(\s|$)/i</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>elHtml<span class="token punctuation">.</span>className<span class="token punctuation">)</span><span class="token punctuation">,</span>
        deviceWidth <span class="token operator">=</span> elHtml<span class="token punctuation">.</span>clientWidth<span class="token punctuation">,</span>
        isQiniuSrc <span class="token operator">=</span> <span class="token regex">/img\.qdaily\.com\//</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span>
        format <span class="token operator">=</span> <span class="token function">_getFormat</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span>
        isGifWebp<span class="token punctuation">,</span> isNotGifWebp<span class="token punctuation">,</span> regDetailImg<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>src <span class="token operator">||</span> <span class="token operator">!</span>isQiniuSrc <span class="token operator">||</span> <span class="token operator">!</span>format <span class="token operator">||</span> format <span class="token operator">==</span> <span class="token string">'webp'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    isNotGifWebp <span class="token operator">=</span> <span class="token punctuation">(</span>format <span class="token operator">!=</span> <span class="token string">'gif'</span> <span class="token operator">&amp;&amp;</span> isSupportWebp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    isGifWebp <span class="token operator">=</span> <span class="token punctuation">(</span>format <span class="token operator">==</span> <span class="token string">'gif'</span> <span class="token operator">&amp;&amp;</span> isSupportWebpAnimation<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据屏幕分辨率计算大小</span>
    src <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\/(thumbnail|crop)\/.*?(\d+)x(\d+)[^\/]*\//ig</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p0<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>dpr <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            p1 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>p1 <span class="token operator">*</span> ratio<span class="token punctuation">[</span>dpr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p2 <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>p2 <span class="token operator">*</span> ratio<span class="token punctuation">[</span>dpr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            match <span class="token operator">=</span> match<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\d+x\d+/</span><span class="token punctuation">,</span> p1 <span class="token operator">+</span> <span class="token string">'x'</span> <span class="token operator">+</span> p2<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> match<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>isNotGifWebp <span class="token operator">||</span> isGifWebp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// 替换webp格式，首页/列表页</span>
        src <span class="token operator">=</span> src<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\/format\/([^\/]*)/ig</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">'/format/webp'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>1、window的屏幕像素密度不一定是整数，mac浏览器缩放之后，屏幕像素密度也不是整数。所以获取dpr一定要取整：dpr = Math.round(window.devicePixelRatio || 1);。<br>
2、ratio = [1, 1, 1.5, 2, 2, 2]表示：1倍屏使用1倍图，2倍屏使用1.5倍图，3倍屏以上都用2倍图。这儿的规则可以按实际情况来设置。<br>
3、webp优化更适合托管到第三方的图片，简单修改参数就可以获取不同的图片。<br></p></div> <img src="/assets/img/16.b6fdf7b1.png" style="width:80%;"> <p><b>srcset兼容性</b></p> <img src="/assets/img/17.aac83782.png" style="width:80%;"> <p>如上所述，在对webp优化的时候，我们顺道模拟实现了srcset：根据屏幕像素密度来设置最适合的图片宽高。<br>
lazysizes原本提供了srcset选项，也可以借用lazysizes的方案来实现srcset，有兴趣的可以去看看源码。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.084c26c5.js" defer></script><script src="/assets/js/2.9f793532.js" defer></script><script src="/assets/js/3.bfde9e20.js" defer></script>
  </body>
</html>
